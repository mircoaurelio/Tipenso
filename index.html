<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vibes Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/xp.css">
    <!-- Spotify iframe API -->
    <script src="https://open.spotify.com/embed-podcast/iframe-api/v1" id="spotify-iframe-api"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #000;
            font-family: "Pixelated MS Sans Serif", Arial;
            touch-action: manipulation; /* Improves touch performance */
        }
        #visualizer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .window {
            position: absolute;
            z-index: 10; /* Increased z-index */
          
            resize: both;
            overflow: hidden;
            min-width: 300px;
            background: rgba(236, 233, 216, 0.95);
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            transition: width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease, transform 0.3s ease;
        }
        
        /* Compact mode for the window - shows more background */
        .window.compact-mode {
            background: rgba(236, 233, 216, 0.85);
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Modal visualizer styles */
        .modal-visualizer-container {
            position: relative;
            width: 100%;
            height: 380px;
            
            border: 1px solid #999;
            border-radius: 5px;
            overflow: hidden;
            background-color: #000;
            transition: height 0.3s ease, min-height 0.3s ease, display 0.1s ease;
        }
        
        #modal-visualizer {
            width: 100%;
            height: 100%;
            display: block;
            background-color: #000;
        }
        
        .visualization-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            transition: opacity 0.3s ease;
            opacity: 0;
            display: none;
        }
        
        /* Hide visualizer on compact mode */
        .compact-mode .modal-visualizer-container {
            display: none;
        }
        
        /* Improved styles for Spotify iframe visibility */
        .player-container {
            position: relative;
            z-index: 15; /* Higher than window */
            min-height: 152px;
            height: 152px;
            
            display: block !important;
            visibility: visible !important;
            width: 100%;
            overflow: visible;
            background-color: rgb(70 86 78);
        }
        
        #spotify-player,
        #spotify-embed-iframe,
        #spotify-embed-iframe iframe {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 20; /* Even higher */
            position: relative;
            border-radius: 12px;
            min-height: 152px;
            width: 100%;
            background-color: white;
            border: none;
        }
        
        /* Force iframe content to be visible */
        iframe {
            background-color: white;
        }
        
        /* Enhance the glass effect for all maximized windows */
        .window.maximized {
            width: 100% !important;
            max-width: 100% !important;
            width: 100vw !important;
            height: calc(100vh - 40px) !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            position: fixed !important;
            transition: all 0.3s ease;
            transform: none !important;
            border-radius: 0 !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
            padding: 0 !important;
            bottom: 40px !important;
            
            /* Enhanced Windows glass effect */
            background-color: rgba(236, 233, 216, 0.7) !important; /* More transparent for better glass effect */
            backdrop-filter: blur(15px) saturate(125%) !important; /* Increased blur and saturation for more noticeable effect */
            -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important; /* Slightly more visible border */
        }
        
        /* Enhanced Windows title bar for maximized state */
        .window.maximized .title-bar {
            background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
            padding: 5px 10px !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
        
        .window.maximized .title-bar-text {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            font-weight: bold !important;
        }
        
        /* Fix specifically for the WMP window when maximized */
        #wmp-window.maximized {
            width: 100% !important;
            max-width: 100% !important;
            width: 100vw !important;
            height: calc(100vh - 40px) !important; /* Default for desktop */
            max-width: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
            z-index: 2000 !important;
            border-radius: 0 !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
            padding: 0 !important;
            right: 0 !important;
            bottom: 60px !important;
            
            /* Enhanced Windows glass effect for WMP specifically */
            background-color: rgba(236, 233, 216, 0.7) !important;
            backdrop-filter: blur(15px) saturate(125%) !important;
            -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
        }
        
        /* Additional styling for WMP in maximized state */
        #wmp-window.maximized .modal-visualizer-container {
            visibility: visible !important;
            display: block !important;
            height: calc(100vh - 280px) !important;
            min-height: 300px !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            background-color: rgba(0, 0, 0, 0.7) !important;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
        }
        
        .window.minimized {
            display: none !important;
        }
        .title-bar {
            background: linear-gradient(180deg, #0058ee 0%, #3a93ff 10%, #288eff 50%, #0058ee 100%);
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none; /* Prevent text selection during drag */
            touch-action: none; /* Prevent touch scrolling for this element */
        }
        .title-bar-text {
            color: white;
            font-weight: bold;
        }
         
        .controls {
            display: none;
            gap: 10px;
            margin-top: 10px;
        }
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%; /* Ensure full width */
            height: 40px;
            background: linear-gradient(to bottom, #1f2f86 0%, #2b44a6 3%, #3b5bdb 6%, #3a59d7 10%, #4b6af5 12%, #4b6af5 21%, #4b6af5 24%, #4b6af5 27%, #4464ee 30%, #4464ee 34%, #4464ee 36%, #425de7 40%, #425de7 44%, #425de7 51%, #425de7 52%, #4b6af5 54%, #4b6af5 57%, #4b6af5 61%, #4b6af5 64%, #4b6af5 67%, #4b6af5 100%);
            z-index: 200000;
            display: flex;
            align-items: center;
             
            border-top: 1px solid #6787e3;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
            box-sizing: border-box; /* Include padding in width calculation */
            overflow: hidden; /* Prevent overflow */
        }
        .start-button {
            height: 36px;
            padding: 1px 8px;
            
            display: flex;
            align-items: center;
            background: linear-gradient(to bottom, #3ba13b 0%, #3ba13b 12%, #40ab40 25%, #40ab40 37%, #45b645 50%, #45b645 62%, #51c751 75%, #51c751 87%, #47b847 100%);
            border: 1px solid #249524;
            border-radius: 3px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
            min-width: 80px; /* Reduced from 90px */
            justify-content: center;
        }
        .start-button:hover {
            background: linear-gradient(to bottom, #4cc24c 0%, #4cc24c 12%, #52d152 25%, #52d152 37%, #59db59 50%, #59db59 62%, #66e666 75%, #66e666 87%, #59db59 100%);
        }
        .start-button:active, .start-button.active {
            background: linear-gradient(to bottom, #33a033 0%, #33a033 12%, #37aa37 25%, #37aa37 37%, #3cb53c 50%, #3cb53c 62%, #45c045 75%, #45c045 87%, #3cb53c 100%);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        .start-button img {
            height: 24px; /* Slightly reduced */
            margin-right: 4px; /* Reduced from 6px */
            margin-left: 2px;
            object-fit: contain; /* Prevents stretching */
            max-width: 100%; /* Ensures image stays within container */
        }
        .active-programs {
            display: flex;
            margin-left: 5px;
            gap: 3px;
            height: 32px;
            margin-top: 2px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            padding-bottom: 4px;
        }
        .program-button {
            padding: 1px 8px; /* Reduced from 10px */
            background: linear-gradient(to bottom, #4b6af5 0%, #3955c9 100%);
            border: 1px solid #1f2f86;
            border-radius: 3px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px; /* Reduced from 5px */
            height: 28px;
            min-width: 110px; /* Reduced from 120px */
            flex-shrink: 0;
        }
        .program-button:hover {
            background: linear-gradient(to bottom, #5c7bff 0%, #4a66da 100%);
        }
        .program-button.active {
            background: linear-gradient(to bottom, #4060e0 0%, #304db3 100%);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        .program-button img {
            height: 24px; /* Bigger icon */
            width: 24px;
            object-fit: contain;
        }
        .taskbar-time {
            position: relative;
            margin-left: auto;
            color: white;
            font-size: 12px; /* Slightly reduced */
            padding: 4px 8px; /* Reduced horizontal padding */
            background: linear-gradient(to bottom, #4b6af5 0%, #3955c9 100%);
            border: 1px solid #1f2f86;
            border-radius: 3px;
            height: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-right: 5px;
            font-weight: bold;
            min-width: 55px; /* Set minimum width */
        }
        .time-display {
            line-height: 1.1;
        }
        .date-display {
            font-size: 9px; /* Smaller date text */
            font-weight: normal;
            line-height: 1;
        }
        .quick-launch {
            display: flex;
            align-items: center;
            gap: 3px; /* Reduced from 4px */
            margin-left: 4px; /* Reduced from 5px */
            padding-left: 4px; /* Reduced from 5px */
            border-left: 1px solid #6787e3;
            height: 32px;
        }
        .quick-launch-icon {
            width: 26px; /* Reduced from 28px */
            height: 26px; /* Reduced from 28px */
            padding: 3px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quick-launch-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .quick-launch-icon img {
            width: 24px; /* Bigger icon */
            height: 24px; /* Make icons square and consistent with desktop */
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Specifically update the mobile version */
        @media (max-width: 768px) {
            .quick-launch-icon img {
                width: 24px; /* Bigger icon */
                height: 24px; /* Make icons square and consistent */
                object-fit: contain;
            }
        }
        
        /* Link styles for IE window */
        .ie-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 5px 0;
        }
        .ie-link {
            display: flex;
            align-items: center;
            padding: 5px;
            text-decoration: none;
            color: #0000EE;
            gap: 8px;
            border-radius: 2px;
        }
        .ie-link:hover {
            background-color: #E8E8F8;
        }
        .ie-link img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .ie-address-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #919B9C;
            background: white;
            padding: 3px 5px;
            font-size: 12px;
        }
        .ie-address-bar span {
            margin-right: 5px;
            font-weight: bold;
        }
        .window.ie-window {
            width: 400px;
            top: 40px;
            height: 350px;
        }
        .window-toolbar {
            border-bottom: 1px solid #919B9C;
            padding: 3px;
            display: flex;
            gap: 5px;
            background: #ECE9D8;
        }
        .toolbar-button {
            min-height: 22px;
            padding: 2px 5px;
            margin: 0;
            font-size: 11px;
        }
        
        /* Windows XP-style notification */
        .xp-notification {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            padding: 12px 20px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            color: #000;
            font-size: 14px;
            z-index: 2000;
            max-width: 90%;
            animation: slideIn 0.3s forwards;
            font-family: "Tahoma", sans-serif;
        }
        .xp-notification.fadeOut {
            animation: fadeOut 0.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Better button styles for mobile */
        button {
            min-height: 28px;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .taskbar {
                height: 50px; /* Slightly reduced height */
                padding: 0 2px;
                width: 100%; /* Ensure full width */
                left: 0;
                right: 0;
            }
            
            .start-button {
                height: 40px; /* Smaller height */
                min-width: 70px; /* Smaller width */
                padding: 1px 5px;
                font-size: 14px;
                margin: 0 3px 0 1px;
            }
            
            .start-button img {
                height: 20px; /* Smaller icon */
                width: 20px;
                margin-right: 4px;
                object-position: center;
            }
            
            .quick-launch {
                gap: 3px;
                height: 40px;
                margin-left: 3px;
                padding-left: 3px;
            }
            
            .quick-launch-icon {
                width: 30px; /* Smaller */
                height: 30px;
                padding: 3px;
            }
            
            .quick-launch-icon img {
                width: 24px; /* Smaller icon */
                height: 24px;
            }
            
            .program-button {
                height: 36px;
                min-width: 100px; /* Reduced width */
                font-size: 11px; /* Smaller text */
                padding: 1px 6px;
            }
            
            .program-button img {
                height: 24px; /* Bigger icon */
                width: 24px;
                margin-right: 3px;
                object-fit: contain;
            }
            
            .active-programs {
                height: 38px;
                margin-top: 2px;
                display: none;
            }
            
            .taskbar-time {
                height: 32px;
                font-size: 13px;
                padding: 2px 6px;
                margin-right: 4px;
                min-width: 50px;
            }
            
            .date-display {
                font-size: 8px;
            }
            
            /* Larger tap targets for mobile */
            button {
                padding: 10px 15px;
                min-height: 44px;
                font-size: 16px;
            }
            
            /* Fix window sizing on mobile */
            .window {
                width: 85vw;
                max-width: 500px;
                 
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            }
            
            /* Larger title bar for easier dragging on mobile */
            .title-bar {
                padding: 8px 10px;
                height: 24px;
            }
            
            /* Make the window title text larger on mobile */
            .title-bar-text {
                font-size: 16px;
            }
            
            /* Make the window control buttons larger for mobile */
            .title-bar-controls button {
                min-width: 30px;
                min-height: 30px;
                margin-left: 4px;
            }
            
            /* Make the XP notification bigger on mobile */
            .xp-notification {
                padding: 15px 20px;
                font-size: 16px;
                bottom: 70px;
            }
            
            /* Adjust IE window for mobile */
            .window.ie-window {
                width: 85vw;
                top:40px;
                height: 70vh;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
                position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
                overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 380px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }
        
        /* Handle screen orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .taskbar {
                height: 38px; /* Even smaller in landscape */
                padding: 0 2px;
            }
            
            .window {
                max-height: calc(100vh - 50px);
            }
            
            /* Adjust icons for landscape */
            .start-button {
                height: 32px;
                min-width: 65px;
                font-size: 12px;
            }
            
            .start-button img {
                height: 18px;
                width: 18px;
            }
            
            .quick-launch-icon {
                width: 32px; /* Increased from 24px */
                height: 32px; /* Increased from 24px */
            }
            
            .quick-launch-icon img {
                width: 24px; /* Increased from 14px to match desktop */
                height: 24px; /* Increased from 14px to match desktop */
                object-fit: contain;
            }
            
            .quick-launch {
                height: 30px;
            }
            
            .active-programs {
                height: 30px;
            }
            
            .program-button {
                height: 28px;
                min-width: 90px;
                font-size: 10px;
            }
            
            .taskbar-time {
                height: 26px;
                padding: 1px 5px;
            }
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Make sure buttons are always clickable */
        button {
            cursor: pointer;
            position: relative;
            z-index: 50;
        }
        
        /* Ensure the spotify-click-detector doesn't block button interaction */
        #spotify-click-detector {
            z-index: 1;
            position: absolute;
            pointer-events: none;
        }
        
        /* Existing styles continue below */
        .player-container {
            background-color: rgb(70, 86, 78);
            height: 152px; /* Exact height to prevent resizing */
            width: 100%;
            position: relative; /* Restore position */
            z-index: 10; /* Restore z-index */
            
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure the controls always have a higher z-index than other elements */
        .controls {
            position: relative;
            z-index: 100;
        }

        /* Windows XP Loading Screen Styles */
        .windows-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a246a; /* Classic Windows XP blue */
            z-index: 100000000000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .windows-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-text {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading-description {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Windows XP logo animation */
        .windows-logo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px auto;
        }
        
        .windows-flag {
            border-radius: 5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
            animation: flag-wave 3s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .windows-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .windows-flag::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        .windows-flag.red::after {
            background-color: #f65314;
        }
        
        .windows-flag.red {
            animation-delay: 0s;
        }
        
        .windows-flag.green::after {
            background-color: #7cbb00;
        }
        
        .windows-flag.green {
            animation-delay: 0.25s;
        }
        
        .windows-flag.blue::after {
            background-color: #00a1f1;
        }
        
        .windows-flag.blue {
            animation-delay: 0.5s;
        }
        
        .windows-flag.yellow::after {
            background-color: #ffbb00;
        }
        
        .windows-flag.yellow {
            animation-delay: 0.75s;
        }
        
        @keyframes flag-wave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.9);
                opacity: 0.8;
            }
        }
        
        /* Mobile optimizations for loading screen */
        @media (max-width: 768px) {
            /* Removed loading bar container mobile styles */
            
            .loading-text {
                font-size: 20px;
            }
            
            .windows-logo {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Share button style */
        .share-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 25;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            font-family: 'Tahoma', sans-serif;
        }
        
        .share-button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            transform: scale(1.02);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .share-button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            /* Mobile-specific styles */
            /* ... existing code ... */
            
            /* Make share button visible on mobile and style it properly */
            .share-button {
                bottom: 12px;
                right: 12px;
                display: flex;
                background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                border-radius: 3px;
                width: auto;
                padding: 8px 12px;
                border: 1px solid #7BA7E1;
                font-family: "Tahoma", sans-serif;
            }
            
            .share-button span {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }
            
            .share-button svg {
                width: 16px;
                height: 16px;
                color: #0046D5;
            }
            
            /* Enhanced controls for mobile */
            .controls {
                display: none !important;
                padding: 10px 5px;
                margin-top: 10px;
                justify-content: space-around;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
                margin: 0 3px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .controls button:active {
                background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
                transform: scale(0.97);
            }
            
            /* Ensure maximize/expand works properly on mobile */
            .window.maximized {
                width: 100% !important;
                max-width: 100% !important;
                width: 100vw !important;
                height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                position: fixed !important;
                transition: all 0.3s ease;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
                padding: 0 !important;
                bottom: 40px !important; /* Also update bottom */
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
            position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
            overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 250px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }
        
        /* Handle screen orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .taskbar {
                height: 38px; /* Even smaller in landscape */
                padding: 0 2px;
            }
            
            .window {
                max-height: calc(100vh - 50px);
            }
            
            /* Adjust icons for landscape */
            .start-button {
                height: 32px;
                min-width: 65px;
                font-size: 12px;
            }
            
            .start-button img {
                height: 18px;
                width: 18px;
            }
            
            .quick-launch-icon {
                width: 32px; /* Increased from 24px */
                height: 32px; /* Increased from 24px */
            }
            
            .quick-launch-icon img {
                width: 24px; /* Increased from 14px to match desktop */
                height: 24px; /* Increased from 14px to match desktop */
                object-fit: contain;
            }
            
            .quick-launch {
                height: 30px;
            }
            
            .active-programs {
                height: 30px;
            }
            
            .program-button {
                height: 28px;
                min-width: 90px;
                font-size: 10px;
            }
            
            .taskbar-time {
                height: 26px;
                padding: 1px 5px;
            }
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Make sure buttons are always clickable */
        button {
            cursor: pointer;
            position: relative;
            z-index: 50;
        }
        
        /* Ensure the spotify-click-detector doesn't block button interaction */
        #spotify-click-detector {
            z-index: 1;
            position: absolute;
            pointer-events: none;
        }
        
        /* Existing styles continue below */
        .player-container {
            background-color: rgb(70, 86, 78);
            height: 152px; /* Exact height to prevent resizing */
            width: 100%;
            position: relative; /* Restore position */
            z-index: 10; /* Restore z-index */
            
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure the controls always have a higher z-index than other elements */
        .controls {
            position: relative;
            z-index: 100;
        }

        /* Windows XP Loading Screen Styles */
        .windows-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a246a; /* Classic Windows XP blue */
            z-index: 100000000000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .windows-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-text {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading-description {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Windows XP logo animation */
        .windows-logo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px auto;
        }
        
        .windows-flag {
            border-radius: 5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
            animation: flag-wave 3s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .windows-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .windows-flag::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        .windows-flag.red::after {
            background-color: #f65314;
        }
        
        .windows-flag.red {
            animation-delay: 0s;
        }
        
        .windows-flag.green::after {
            background-color: #7cbb00;
        }
        
        .windows-flag.green {
            animation-delay: 0.25s;
        }
        
        .windows-flag.blue::after {
            background-color: #00a1f1;
        }
        
        .windows-flag.blue {
            animation-delay: 0.5s;
        }
        
        .windows-flag.yellow::after {
            background-color: #ffbb00;
        }
        
        .windows-flag.yellow {
            animation-delay: 0.75s;
        }
        
        @keyframes flag-wave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.9);
                opacity: 0.8;
            }
        }
        
        /* Mobile optimizations for loading screen */
        @media (max-width: 768px) {
            /* Removed loading bar container mobile styles */
            
            .loading-text {
                font-size: 20px;
            }
            
            .windows-logo {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Share button style */
        .share-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 25;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            font-family: 'Tahoma', sans-serif;
        }
        
        .share-button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            transform: scale(1.02);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .share-button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            /* Mobile-specific styles */
            /* ... existing code ... */
            
            /* Make share button visible on mobile and style it properly */
            .share-button {
                bottom: 12px;
                right: 12px;
                display: flex;
                background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                border-radius: 3px;
                width: auto;
                padding: 8px 12px;
                border: 1px solid #7BA7E1;
                font-family: "Tahoma", sans-serif;
            }
            
            .share-button span {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }
            
            .share-button svg {
                width: 16px;
                height: 16px;
                color: #0046D5;
            }
            
            /* Enhanced controls for mobile */
            .controls {
                display: none !important;
                padding: 10px 5px;
                margin-top: 10px;
                justify-content: space-around;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
                margin: 0 3px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .controls button:active {
                background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
                transform: scale(0.97);
            }
            
            /* Ensure maximize/expand works properly on mobile */
            .window.maximized {
                width: 100% !important;
                max-width: 100% !important;
                width: 100vw !important;
                height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                position: fixed !important;
                transition: all 0.3s ease;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
                padding: 0 !important;
                bottom: 40px !important; /* Also update bottom */
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
            position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
            overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 250px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }
        
        /* Handle screen orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .taskbar {
                height: 38px; /* Even smaller in landscape */
                padding: 0 2px;
            }
            
            .window {
                max-height: calc(100vh - 50px);
            }
            
            /* Adjust icons for landscape */
            .start-button {
                height: 32px;
                min-width: 65px;
                font-size: 12px;
            }
            
            .start-button img {
                height: 18px;
                width: 18px;
            }
            
            .quick-launch-icon {
                width: 32px; /* Increased from 24px */
                height: 32px; /* Increased from 24px */
            }
            
            .quick-launch-icon img {
                width: 24px; /* Increased from 14px to match desktop */
                height: 24px; /* Increased from 14px to match desktop */
                object-fit: contain;
            }
            
            .quick-launch {
                height: 30px;
            }
            
            .active-programs {
                height: 30px;
            }
            
            .program-button {
                height: 28px;
                min-width: 90px;
                font-size: 10px;
            }
            
            .taskbar-time {
                height: 26px;
                padding: 1px 5px;
            }
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Make sure buttons are always clickable */
        button {
            cursor: pointer;
            position: relative;
            z-index: 50;
        }
        
        /* Ensure the spotify-click-detector doesn't block button interaction */
        #spotify-click-detector {
            z-index: 1;
            position: absolute;
            pointer-events: none;
        }
        
        /* Existing styles continue below */
        .player-container {
            background-color: rgb(70, 86, 78);
            height: 152px; /* Exact height to prevent resizing */
            width: 100%;
            position: relative; /* Restore position */
            z-index: 10; /* Restore z-index */
            
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure the controls always have a higher z-index than other elements */
        .controls {
            position: relative;
            z-index: 100;
        }

        /* Windows XP Loading Screen Styles */
        .windows-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a246a; /* Classic Windows XP blue */
            z-index: 100000000000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .windows-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-text {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading-description {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Windows XP logo animation */
        .windows-logo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px auto;
        }
        
        .windows-flag {
            border-radius: 5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
            animation: flag-wave 3s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .windows-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .windows-flag::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        .windows-flag.red::after {
            background-color: #f65314;
        }
        
        .windows-flag.red {
            animation-delay: 0s;
        }
        
        .windows-flag.green::after {
            background-color: #7cbb00;
        }
        
        .windows-flag.green {
            animation-delay: 0.25s;
        }
        
        .windows-flag.blue::after {
            background-color: #00a1f1;
        }
        
        .windows-flag.blue {
            animation-delay: 0.5s;
        }
        
        .windows-flag.yellow::after {
            background-color: #ffbb00;
        }
        
        .windows-flag.yellow {
            animation-delay: 0.75s;
        }
        
        @keyframes flag-wave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.9);
                opacity: 0.8;
            }
        }
        
        /* Mobile optimizations for loading screen */
        @media (max-width: 768px) {
            /* Removed loading bar container mobile styles */
            
            .loading-text {
                font-size: 20px;
            }
            
            .windows-logo {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Share button style */
        .share-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 25;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            font-family: 'Tahoma', sans-serif;
        }
        
        .share-button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            transform: scale(1.02);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .share-button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            /* Mobile-specific styles */
            /* ... existing code ... */
            
            /* Make share button visible on mobile and style it properly */
            .share-button {
                bottom: 12px;
                right: 12px;
                display: flex;
                background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                border-radius: 3px;
                width: auto;
                padding: 8px 12px;
                border: 1px solid #7BA7E1;
                font-family: "Tahoma", sans-serif;
            }
            
            .share-button span {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }
            
            .share-button svg {
                width: 16px;
                height: 16px;
                color: #0046D5;
            }
            
            /* Enhanced controls for mobile */
            .controls {
                display: none !important;
                padding: 10px 5px;
                margin-top: 10px;
                justify-content: space-around;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
                margin: 0 3px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .controls button:active {
                background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
                transform: scale(0.97);
            }
            
            /* Ensure maximize/expand works properly on mobile */
            .window.maximized {
                width: 100% !important;
                max-width: 100% !important;
                width: 100vw !important;
                height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                position: fixed !important;
                transition: all 0.3s ease;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
                padding: 0 !important;
                bottom: 40px !important; /* Also update bottom */
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            #wmp-window.maximized {
                height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                bottom: 40px !important;
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
                position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
            overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 250px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }
        
        /* Handle screen orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .taskbar {
                height: 38px; /* Even smaller in landscape */
                padding: 0 2px;
            }
            
            .window {
                max-height: calc(100vh - 50px);
            }
            
            /* Adjust icons for landscape */
            .start-button {
                height: 32px;
                min-width: 65px;
                font-size: 12px;
            }
            
            .start-button img {
                height: 18px;
                width: 18px;
            }
            
            .quick-launch-icon {
                width: 32px; /* Increased from 24px */
                height: 32px; /* Increased from 24px */
            }
            
            .quick-launch-icon img {
                width: 24px; /* Increased from 14px to match desktop */
                height: 24px; /* Increased from 14px to match desktop */
                object-fit: contain;
            }
            
            .quick-launch {
                height: 30px;
            }
            
            .active-programs {
                height: 30px;
            }
            
            .program-button {
                height: 28px;
                min-width: 90px;
                font-size: 10px;
            }
            
            .taskbar-time {
                height: 26px;
                padding: 1px 5px;
            }
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Make sure buttons are always clickable */
        button {
            cursor: pointer;
            position: relative;
            z-index: 50;
        }
        
        /* Ensure the spotify-click-detector doesn't block button interaction */
        #spotify-click-detector {
            z-index: 1;
            position: absolute;
            pointer-events: none;
        }
        
        /* Existing styles continue below */
        .player-container {
            background-color: rgb(70, 86, 78);
            height: 152px; /* Exact height to prevent resizing */
            width: 100%;
            position: relative; /* Restore position */
            z-index: 10; /* Restore z-index */
            
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure the controls always have a higher z-index than other elements */
        .controls {
            position: relative;
            z-index: 100;
        }

        /* Windows XP Loading Screen Styles */
        .windows-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a246a; /* Classic Windows XP blue */
            z-index: 100000000000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .windows-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-text {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading-description {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Windows XP logo animation */
        .windows-logo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px auto;
        }
        
        .windows-flag {
            border-radius: 5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
            animation: flag-wave 3s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .windows-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .windows-flag::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        .windows-flag.red::after {
            background-color: #f65314;
        }
        
        .windows-flag.red {
            animation-delay: 0s;
        }
        
        .windows-flag.green::after {
            background-color: #7cbb00;
        }
        
        .windows-flag.green {
            animation-delay: 0.25s;
        }
        
        .windows-flag.blue::after {
            background-color: #00a1f1;
        }
        
        .windows-flag.blue {
            animation-delay: 0.5s;
        }
        
        .windows-flag.yellow::after {
            background-color: #ffbb00;
        }
        
        .windows-flag.yellow {
            animation-delay: 0.75s;
        }
        
        @keyframes flag-wave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.9);
                opacity: 0.8;
            }
        }
        
        /* Mobile optimizations for loading screen */
        @media (max-width: 768px) {
            /* Removed loading bar container mobile styles */
            
            .loading-text {
                font-size: 20px;
            }
            
            .windows-logo {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Share button style */
        .share-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 25;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            font-family: 'Tahoma', sans-serif;
        }
        
        .share-button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            transform: scale(1.02);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .share-button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            /* Mobile-specific styles */
            /* ... existing code ... */
            
            /* Make share button visible on mobile and style it properly */
            .share-button {
                bottom: 12px;
                right: 12px;
                display: flex;
                background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                border-radius: 3px;
                width: auto;
                padding: 8px 12px;
                border: 1px solid #7BA7E1;
                font-family: "Tahoma", sans-serif;
            }
            
            .share-button span {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }
            
            .share-button svg {
                width: 16px;
                height: 16px;
                color: #0046D5;
            }
            
            /* Enhanced controls for mobile */
            .controls {
                display: none !important;
                padding: 10px 5px;
                margin-top: 10px;
                justify-content: space-around;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
                margin: 0 3px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .controls button:active {
                background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
                transform: scale(0.97);
            }
            
            /* Ensure maximize/expand works properly on mobile */
            .window.maximized {
                width: 100% !important;
                max-width: 100% !important;
                width: 100vw !important;
                height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                position: fixed !important;
                transition: all 0.3s ease;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
                padding: 0 !important;
                bottom: 40px !important; /* Also update bottom */
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            #wmp-window.maximized {
                height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                bottom: 40px !important;
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
                position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
            overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 380px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }
        
        /* Handle screen orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .taskbar {
                height: 38px; /* Even smaller in landscape */
                padding: 0 2px;
            }
            
            .window {
                max-height: calc(100vh - 50px);
            }
            
            /* Adjust icons for landscape */
            .start-button {
                height: 32px;
                min-width: 65px;
                font-size: 12px;
            }
            
            .start-button img {
                height: 18px;
                width: 18px;
            }
            
            .quick-launch-icon {
                width: 32px; /* Increased from 24px */
                height: 32px; /* Increased from 24px */
            }
            
            .quick-launch-icon img {
                width: 24px; /* Increased from 14px to match desktop */
                height: 24px; /* Increased from 14px to match desktop */
                object-fit: contain;
            }
            
            .quick-launch {
                height: 30px;
            }
            
            .active-programs {
                height: 30px;
            }
            
            .program-button {
                height: 28px;
                min-width: 90px;
                font-size: 10px;
            }
            
            .taskbar-time {
                height: 26px;
                padding: 1px 5px;
            }
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Make sure buttons are always clickable */
        button {
            cursor: pointer;
            position: relative;
            z-index: 50;
        }
        
        /* Ensure the spotify-click-detector doesn't block button interaction */
        #spotify-click-detector {
            z-index: 1;
            position: absolute;
            pointer-events: none;
        }
        
        /* Existing styles continue below */
        .player-container {
            background-color: rgb(70, 86, 78);
            height: 152px; /* Exact height to prevent resizing */
            width: 100%;
            position: relative; /* Restore position */
            z-index: 10; /* Restore z-index */
            
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure the controls always have a higher z-index than other elements */
        .controls {
            position: relative;
            z-index: 100;
        }

        /* Windows XP Loading Screen Styles */
        .windows-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a246a; /* Classic Windows XP blue */
            z-index: 100000000000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .windows-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-text {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .loading-description {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Windows XP logo animation */
        .windows-logo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            width: 120px;
            height: 120px;
            margin: 0 auto 30px auto;
        }
        
        .windows-flag {
            border-radius: 5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
            animation: flag-wave 3s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .windows-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .windows-flag::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        .windows-flag.red::after {
            background-color: #f65314;
        }
        
        .windows-flag.red {
            animation-delay: 0s;
        }
        
        .windows-flag.green::after {
            background-color: #7cbb00;
        }
        
        .windows-flag.green {
            animation-delay: 0.25s;
        }
        
        .windows-flag.blue::after {
            background-color: #00a1f1;
        }
        
        .windows-flag.blue {
            animation-delay: 0.5s;
        }
        
        .windows-flag.yellow::after {
            background-color: #ffbb00;
        }
        
        .windows-flag.yellow {
            animation-delay: 0.75s;
        }
        
        @keyframes flag-wave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.9);
                opacity: 0.8;
            }
        }
        
        /* Mobile optimizations for loading screen */
        @media (max-width: 768px) {
            /* Removed loading bar container mobile styles */
            
            .loading-text {
                font-size: 20px;
            }
            
            .windows-logo {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Share button style */
        .share-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 25;
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            border-radius: 3px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            font-family: 'Tahoma', sans-serif;
        }
        
        .share-button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            transform: scale(1.02);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .share-button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            /* Mobile-specific styles */
            /* ... existing code ... */
            
            /* Make share button visible on mobile and style it properly */
            .share-button {
                bottom: 12px;
                right: 12px;
                display: flex;
                background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                border-radius: 3px;
                width: auto;
                padding: 8px 12px;
                border: 1px solid #7BA7E1;
                font-family: "Tahoma", sans-serif;
            }
            
            .share-button span {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            }
            
            .share-button svg {
                width: 16px;
                height: 16px;
                color: #0046D5;
            }
            
            /* Enhanced controls for mobile */
            .controls {
                display: none !important;
                padding: 10px 5px;
                margin-top: 10px;
                justify-content: space-around;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
                margin: 0 3px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .controls button:active {
                background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
                transform: scale(0.97);
            }
            
            /* Ensure maximize/expand works properly on mobile */
            .window.maximized {
                width: 100% !important;
                max-width: 100% !important;
                width: 100vw !important;
                height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                position: fixed !important;
                transition: all 0.3s ease;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
                padding: 0 !important;
                bottom: 40px !important; /* Also update bottom */
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            #wmp-window.maximized {
                height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                bottom: 40px !important;
                
                /* Windows glass effect for mobile */
                background-color: rgba(236, 233, 216, 0.7) !important;
                backdrop-filter: blur(15px) saturate(125%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.6) !important;
            }
            
            .ie-link {
                padding: 8px 5px;
            }
            
            /* Hide toggle and kaleidoscope buttons on mobile */
            .btn-toggle-play, 
            .btn-kaleidoscope, 
            .btn-debug {
                display: none !important;
            }
            
            /* Simplified controls for mobile */
            .controls {
                margin-top: 10px;
                display: none;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            
            .controls button {
                margin: 0 5px;
                height: 40px;  /* Bigger touch target */
                min-width: 80px;
                font-size: 14px;
                padding: 8px 12px;
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border-radius: 6px;
                z-index: 100;  /* Ensure buttons are above other elements */
                position: relative;
                touch-action: manipulation;  /* Improve touch handling */
                -webkit-tap-highlight-color: rgba(0,0,0,0);  /* Remove default mobile tap highlight */
            }
            
            /* Visual feedback for active state */
            .controls button:active {
                background-color: rgba(255,255,255,0.3) !important;
                transform: scale(0.97);
            }
            
            #spotify-click-detector {
                pointer-events: none; /* Ensure this doesn't block clicks */
            }
            
            .player-container {
                background-color: rgb(70, 86, 78);
                height: 152px; /* Exact height to prevent resizing */
                width: 100%;
            overflow: hidden;
                box-sizing: border-box;
            }
            
            #spotify-player {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                overflow: hidden;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            #spotify-embed-iframe, 
            #spotify-embed-iframe iframe {
                display: block;
                visibility: visible;
                position: relative;
                z-index: 20;
                background-color: white;
                height: 152px;
                width: 100%;
            }
            
            /* Debugging - Mark buttons to see if they're visibly rendered correctly */
            .controls:after {
                content: "";
                display: block;
                clear: both;
            }
            
            /* Modal visualizer container for mobile */
            .modal-visualizer-container {
                height: 352px;
                min-height: 250px;
                z-index: 5;
            }
            
            /* Ensure WMP window has proper z-index */
            #wmp-window {
                z-index: 1000;
                position: relative;
            }
            
            /* Fix for any potential issues with bubbling */
            html, body {
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Make share button more visible on mobile */
            .share-button {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            }
            
            .share-button svg {
                width: 20px;
                height: 20px;
            }
            
            /* Expanded view for mobile */
            @media (max-width: 768px) {
                .window.maximized .modal-visualizer-container {
                    height: calc(100vh - 250px) !important;
                    min-height: 300px !important;
                    transition: height 0.3s ease;
                    visibility: visible !important;
                    display: block !important;
                    border: 1px solid rgba(255, 255, 255, 0.4) !important;
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3) !important;
                }
                
                /* Enhanced Windows title bar for maximized state on mobile */
                .window.maximized .title-bar {
                    background: linear-gradient(180deg, rgba(40, 110, 220, 0.9) 0%, rgba(36, 100, 210, 0.9) 50%, rgba(30, 90, 200, 0.9) 100%) !important;
                    backdrop-filter: blur(10px) !important;
                    -webkit-backdrop-filter: blur(10px) !important;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    padding: 8px 10px !important; /* Slightly larger padding for mobile */
                    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
                }
                
                .window.maximized {
                    width: 100% !important;
                    max-width: 100% !important;
                    width: 100vw !important;
                    height: calc(100vh - 40px) !important; /* Mobile has 70px taskbar */
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    margin: 0 !important;
                    position: fixed !important;
                    transition: all 0.3s ease;
                    transform: none !important;
                    border-radius: 0 !important;
                    overflow: hidden !important;
                    box-sizing: border-box !important;
                    padding: 0 !important;
                    bottom: 70px !important; /* Also update bottom */
                    
                    /* Enhanced Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
                
                #wmp-window.maximized {
                    height: calc(100vh - 40px) !important; /* Taskbar is 40px */
                    bottom: 40px !important;
                    
                    /* Windows glass effect for mobile */
                    background-color: rgba(236, 233, 216, 0.7) !important;
                    backdrop-filter: blur(15px) saturate(125%) !important;
                    -webkit-backdrop-filter: blur(15px) saturate(125%) !important;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
                    border: 1px solid rgba(255, 255, 255, 0.6) !important;
                }
            }
        }

        /* Buttons in Windows XP style */
        .controls button {
            background: linear-gradient(to bottom, #EDF6FF 0%, #D0E6F9 50%, #C4E0FC 51%, #ABD4FC 100%);
            border: 1px solid #7BA7E1;
            color: #000;
            font-family: 'Tahoma', sans-serif;
            border-radius: 3px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .controls button:hover {
            background: linear-gradient(to bottom, #F3FAFF 0%, #E2F0FC 50%, #D6EDFF 51%, #C1E3FF 100%);
            border-color: #8CB8F3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .controls button:active {
            background: linear-gradient(to bottom, #C1E3FF 0%, #D6EDFF 50%, #E2F0FC 51%, #F3FAFF 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* Window state transitions */
        .window {
            transition: width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease, transform 0.3s ease;
        }
        
        /* Make transitions smoother for visualizer container */
        .modal-visualizer-container {
            transition: height 0.3s ease, min-height 0.3s ease, display 0.1s ease;
        }
        
        /* Additional styling for WMP in maximized state */
        #wmp-window.maximized .modal-visualizer-container {
            visibility: visible !important;
            display: block !important;
            height: calc(100vh - 280px) !important;
            min-height: 300px !important;
        }
        
        /* Ensure all controls are visible in maximized state */
        #wmp-window.maximized .controls {
            display: none !important;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        /* Reset any fixed width that might be interfering with maximization */
        #wmp-window {
            max-width: 800px; /* Default max-width */
            width: auto; /* Let it size naturally */
            transition: all 0.3s ease;
        }
        
        #wmp-window.maximized {
            max-width: none !important; /* Override max-width when maximized */
        }

     

        .window.maximized .title-bar-controls button:hover {
            background-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3) !important;
        }

        /* Special styling for close button */
        .window.maximized .title-bar-controls button[aria-label="Close"] {
            background-color: rgba(232, 17, 35, 0.7) !important; /* Windows close button red */
            /* Do not override the original background-image */
        }

        .window.maximized .title-bar-controls button[aria-label="Close"]:hover {
            background-color: rgba(232, 17, 35, 0.9) !important;
            box-shadow: 0 0 5px rgba(232, 17, 35, 0.5) !important;
        }
        .window .window-body {
            margin: 0 !important;

        }
        /* Remove 8px margin from window-body when maximized */
        .window.maximized .window-body {
            margin: 0 !important;
            background-color: transparent !important; /* Windows classic background color */
            border-top: none !important;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1) !important;
        }

        /* Add styles for Venerus Spotify mode */
        .venerus-spotify-mode .player-container {
            height: 100% !important;
            max-height: none !important;
        }
        
        .venerus-spotify-mode #spotify-player {
            height: 100% !important;
            max-height: none !important;
        }
        
        .venerus-spotify-mode .window-body {
            height: calc(100% - 22px) !important; /* Account for title bar */
            display: flex !important;
            flex-direction: column !important;
        }
    </style>
</head>
<body>
    <canvas id="visualizer"></canvas>
    
    <div class="window" id="wmp-window">
        <div class="title-bar">
            <div class="title-bar-text">Media Player</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <!-- Add secondary canvas visualization inside the window -->
            <div class="modal-visualizer-container">
                <iframe id="spotify-player"
                    style="border-radius:12px; display: block !important; position: absolute; z-index: 0; top: -6%; width: 100%; height: 100%; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);"
                    src="https://open.spotify.com/embed/track/264hK4WMZsBIpmIhdBXZrh?utm_source=generator&theme=0"
                    frameBorder="0" 
                    allowfullscreen=""
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="eager">
                </iframe>
                <img src="shaders/default.png"  style="pointer-events: none; width: 100%; height: 100%;  position: absolute; top: 0; left: 0; z-index: 0;">
                <canvas id="modal-visualizer"></canvas>
                <div class="visualization-status"></div>
                <!-- Windows XP Style Share Button (Initially Hidden) -->
                <button id="share-song-button" class="xp-button" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; display: none; cursor: pointer; font-family: 'Tahoma', sans-serif; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                    <img src="https://win98icons.alexmeub.com/icons/png/windows-update-4.png" alt="Share" style="width: 16px; height: 16px; margin-right: 4px;">
                    Condividi questa canzone
                </button>
            </div>
            
            <div class="controls">
                <button class="btn-visualization">Visual: Medium</button>
                <button class="btn-fullscreen">Expand</button>
                <button class="btn-toggle-play" id="toggle-button">Play</button>
                <button class="btn-kaleidoscope">Kaleidoscope: 1</button>
                <button class="btn-change-track">Track ▼</button>
                <button class="btn-debug" style="display:none;">Debug</button>
                <div id="playback-status" class="status-paused">Paused</div>
            </div>
        </div>
    </div>
    
    <!-- New dedicated Venerus Spotify window -->
    <div class="window" id="venerus-window" style="display: none; z-index: 3;">
        <div class="title-bar">
            <div class="title-bar-text">Venerus Spotify</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body" style="margin: 0; padding: 0; height: calc(100% - 22px); display: flex; flex-direction: column;">
            <div class="venerus-player-container" style="position: relative; z-index: 15; height: 100%; width: 100%; background-color: rgb(70 86 78); overflow: hidden; box-sizing: border-box; flex: 1;">
                <iframe id="venerus-spotify-player"
                    style="border-radius:12px; display: block !important; position: relative; z-index: 20; width: 100%; height: 100%; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);"
                    src="https://open.spotify.com/embed/artist/49faW2w8eguUIAG5c85KcD?utm_source=generator&theme=0"
                    frameBorder="0" 
                    allowfullscreen=""
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="lazy">
                </iframe>
            </div>
        </div>
    </div>
    
    <div class="window ie-window" id="ie-window" style="display: none;">
        <div class="title-bar">
            <div class="title-bar-text">Vibes Explorer</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            
            <div class="ie-address-bar">
                <span>Address:</span> https://venerus.eu/
            </div>
            <div class="ie-links">
                <a href="https://open.spotify.com/intl-it/artist/49faW2w8eguUIAG5c85KcD" target="_blank" class="ie-link">
                    <img src="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_RGB_Green.png" alt="Spotify">
                    <span>Venerus - Spotify Artist Page</span>
                </a>
                <a href="https://www.instagram.com/venerus/?hl=it" target="_blank" class="ie-link">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/600px-Instagram_icon.png" alt="Instagram">
                    <span>Venerus - Instagram</span>
                </a>
                <a href="https://venerus.eu/" target="_blank" class="ie-link">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c4/Globe_icon.svg/1024px-Globe_icon.svg.png" alt="Website">
                    <span>Venerus - Official Website</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="taskbar">
        <button class="start-button" id="taskbar-share-button">
            <img src="https://win98icons.alexmeub.com/icons/png/windows-0.png" alt="Share">
            Share
        </button>
        <div class="quick-launch">
            <button class="quick-launch-icon" id="wmp-icon" title="Windows Media Player">
                <img src="https://win98icons.alexmeub.com/icons/png/media_player-0.png" alt="WMP">
            </button>
            <button class="quick-launch-icon" id="ie-icon" title="Internet Explorer">
                <img src="https://win98icons.alexmeub.com/icons/png/msie1-0.png" alt="IE">
            </button>
            <!-- Changed Show Desktop to Venerus Spotify -->
            <button class="quick-launch-icon" id="show-desktop" title="Venerus Spotify">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/240px-Spotify_logo_without_text.svg.png" alt="Venerus Spotify">
            </button>
        </div>
        <div class="active-programs" id="active-programs">
            <!-- Program buttons will be added dynamically when windows are opened -->
        </div>
        <div class="taskbar-time" id="taskbar-time">
            <div class="time-display"></div>
            <div class="date-display"></div>
        </div>
    </div>

    <!-- Windows XP Loading Screen Overlay -->
    <div id="windows-loading-overlay" class="windows-loading-overlay">
        <div class="loading-content">
            <div class="windows-logo">
                <div class="windows-flag red">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Cat_poster_1.jpg/320px-Cat_poster_1.jpg" alt="Cat 1">
            </div>
                <div class="windows-flag green">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/Cat_November_2010-1a.jpg/320px-Cat_November_2010-1a.jpg" alt="Cat 2">
            </div>
                <div class="windows-flag blue">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Cat03.jpg/320px-Cat03.jpg" alt="Cat 3">
                </div>
                <div class="windows-flag yellow">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/Kittyply_edit1.jpg/320px-Kittyply_edit1.jpg" alt="Cat 4">
                </div>
            </div>
            <!-- Loading bar removed -->
            <div class="loading-description"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="visualizer.js"></script>
    <script>
        // Add window control functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle Windows XP loading screen
            const loadingOverlay = document.getElementById('windows-loading-overlay');
            // Remove reference to loading bar since it's been removed
            const spotifyIframe = document.getElementById('spotify-player');
            
            // Start loading animation
            let loadingProgress = 0;
            let loadingInterval;
            let loadingTimeout;
            
            function startLoadingAnimation() {
                // Update loading messages without animating a loading bar
                loadingInterval = setInterval(() => {
                    loadingProgress += 0.5;
                    
                    // Update loading messages based on progress
                    updateLoadingText(loadingProgress);
                }, 100);
                
                // Set a maximum timeout (15 seconds) to hide loading screen even if iframe doesn't load
                loadingTimeout = setTimeout(() => {
                    completeLoading();
                }, 15000);
            }
            
            function updateLoadingText(progress) {
                // Update loading text based on progress
                if (progress > 80) {
                    document.querySelector('.loading-description').textContent = 'Almost ready...';
                } else if (progress > 50) {
                    document.querySelector('.loading-description').textContent = 'Loading Spotify player...';
                } else if (progress > 20) {
                    document.querySelector('.loading-description').textContent = 'Initializing audio system...';
                }
            }
            
            function completeLoading() {
                // Clear any pending intervals/timeouts
                clearInterval(loadingInterval);
                clearTimeout(loadingTimeout);
                
                // Update final loading state
                document.querySelector('.loading-description').textContent = '';
                
                // Wait a moment to show the completed message
                setTimeout(() => {
                    // Hide the loading overlay
                    loadingOverlay.classList.add('hidden');
                    
                    // Remove it from DOM after animation completes
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 500);
            }
            
            // Start loading animation immediately
            startLoadingAnimation();
            
            // Listen for iframe load event
            spotifyIframe.addEventListener('load', function() {
                // Wait a short moment to ensure iframe is fully interactive
                setTimeout(() => {
                    completeLoading();
                }, 1000);
            });
            
            // Set up share functionality
            const shareButton = document.getElementById('share-button');
            const taskbarShareButton = document.getElementById('taskbar-share-button');
            const shareSongButton = document.getElementById('share-song-button');
            
            function handleShare() {
                // Get the current URL
                const url = window.location.href;
                // Format the share text as specified
                const shareText = `Ti penso - mentre ascolto:`;
                
                // Check if the Web Share API is supported (mainly on mobile)
                if (navigator.share) {
                    navigator.share({
                        title: 'Windows XP Music Visualizer',
                        text: shareText,
                        url: url
                    })
                    .then(() => console.log('Shared successfully'))
                    .catch((error) => console.log('Error sharing:', error));
                } else {
                    // Fallback for desktop - copy to clipboard
                    try {
                        navigator.clipboard.writeText(shareText)
                            .then(() => {
                                // Create temporary feedback element
                                const feedback = document.createElement('div');
                                feedback.textContent = 'Link copied to clipboard!';
                                feedback.style.position = 'fixed';
                                feedback.style.bottom = '80px';
                                feedback.style.left = '50%';
                                feedback.style.transform = 'translateX(-50%)';
                                feedback.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                                feedback.style.color = 'white';
                                feedback.style.padding = '10px 15px';
                                feedback.style.borderRadius = '5px';
                                feedback.style.zIndex = '10000';
                                feedback.style.fontSize = '14px';
                                
                                document.body.appendChild(feedback);
                                
                                // Remove after 2 seconds
                                setTimeout(() => {
                                    feedback.style.opacity = '0';
                                    feedback.style.transition = 'opacity 0.5s';
                                    
                                    setTimeout(() => {
                                        document.body.removeChild(feedback);
                                    }, 500);
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy text: ', err);
                                // Try alternative method for older browsers
                                const textarea = document.createElement('textarea');
                                textarea.value = shareText;
                                textarea.style.position = 'fixed';
                                textarea.style.opacity = '0';
                                document.body.appendChild(textarea);
                                textarea.focus();
                                textarea.select();
                                
                                try {
                                    document.execCommand('copy');
                                    alert('Link copied to clipboard!');
                                } catch (e) {
                                    console.error('Failed to copy with execCommand:', e);
                                    alert('Could not copy the link. Please copy this manually:\n\n' + shareText);
                                }
                                
                                document.body.removeChild(textarea);
                            });
                    } catch (err) {
                        console.error('Clipboard API not supported:', err);
                        alert('Please copy this link manually:\n\n' + shareText);
                    }
                }
            }
            
            // Add event listeners to share buttons
            if (shareButton) {
                // Use both click and touchend to ensure good mobile experience
                shareButton.addEventListener('click', handleShare);
                shareButton.addEventListener('touchend', (e) => {
                    e.preventDefault(); // Prevent double triggering on mobile
                    handleShare();
                });
                
                // Add visual feedback on mobile touch
                shareButton.addEventListener('touchstart', () => {
                    shareButton.style.transform = 'scale(0.95)';
                    shareButton.style.backgroundColor = 'rgba(255, 255, 255, 1)';
                });
                
                shareButton.addEventListener('touchend', () => {
                    shareButton.style.transform = '';
                    shareButton.style.backgroundColor = '';
                });
            }
            
            // Connect the taskbar share button to the same functionality
            if (taskbarShareButton) {
                // Use both click and touchend to ensure good mobile experience
                taskbarShareButton.addEventListener('click', handleShare);
                taskbarShareButton.addEventListener('touchend', (e) => {
                    e.preventDefault(); // Prevent double triggering on mobile
                    handleShare();
                });
                
                // Add visual feedback on mobile touch
                taskbarShareButton.addEventListener('touchstart', () => {
                    taskbarShareButton.classList.add('active');
                });
                
                taskbarShareButton.addEventListener('touchend', () => {
                    taskbarShareButton.classList.remove('active');
                });
            }
            
            // Connect the song share button to the same functionality
            if (shareSongButton) {
                shareSongButton.addEventListener('click', handleShare);
                shareSongButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleShare();
                });
                
                // Add Windows XP button hover effect
                shareSongButton.addEventListener('mouseover', () => {
                    shareSongButton.style.background = 'linear-gradient(to bottom, #f0f0e8, #e0dfd8)';
                });
                
                shareSongButton.addEventListener('mouseout', () => {
                    shareSongButton.style.background = 'linear-gradient(to bottom, #ebeadb, #cfd0c8)';
                });
                
                shareSongButton.addEventListener('mousedown', () => {
                    shareSongButton.style.background = 'linear-gradient(to bottom, #cfd0c8, #ebeadb)';
                    shareSongButton.style.transform = 'translateY(1px)';
                });
                
                shareSongButton.addEventListener('mouseup', () => {
                    shareSongButton.style.background = 'linear-gradient(to bottom, #ebeadb, #cfd0c8)';
                    shareSongButton.style.transform = 'translateY(0)';
                });
            }
            
            // Show the share song button after 30 seconds of playing
            let shareSongButtonTimer;
            const toggleButton = document.getElementById('toggle-button');
            const playbackStatus = document.getElementById('playback-status');
            
            if (toggleButton && shareSongButton) {
                // First, set up the click handler for the toggle button
                toggleButton.addEventListener('click', function() {
                    const isPlaying = toggleButton.textContent === 'Pause';
                    
                    if (isPlaying) {
                        // Start the 30-second timer when music is playing
                        startShareButtonTimer();
                    } else {
                        // Clear the timer if music is paused
                        clearTimeout(shareSongButtonTimer);
                        // Hide the button if it was visible
                        shareSongButton.style.display = 'none';
                    }
                });
                
                // Also monitor the playback status element for changes
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' || mutation.type === 'childList') {
                            const isPlaying = playbackStatus.textContent === 'Playing' || 
                                            playbackStatus.classList.contains('status-playing') ||
                                            !playbackStatus.classList.contains('status-paused');
                            
                            if (isPlaying && shareSongButton.style.display === 'none') {
                                startShareButtonTimer();
                            } else if (!isPlaying) {
                                clearTimeout(shareSongButtonTimer);
                                shareSongButton.style.display = 'none';
                            }
                        }
                    });
                });
                
                // Observe both class changes and content changes
                observer.observe(playbackStatus, { 
                    attributes: true, 
                    childList: true,
                    attributeFilter: ['class']
                });
                
                // Function to start the timer and show the button
                function startShareButtonTimer() {
                    clearTimeout(shareSongButtonTimer); // Clear any existing timer
                    
                    // Set timeout to 30 seconds
                    const timeout = 30000; // 30 seconds
                    
                    console.log('Starting share button timer...');
                    
                    shareSongButtonTimer = setTimeout(() => {
                        console.log('Share button timer triggered!');
                        shareSongButton.style.display = 'block';
                        // Add a fade-in animation
                        shareSongButton.style.opacity = '0';
                        shareSongButton.style.transition = 'opacity 0.5s ease-in';
                        setTimeout(() => {
                            shareSongButton.style.opacity = '1';
                        }, 10);
                    }, timeout);
                }
                
                // Check with Spotify controller directly after it's available
                if (window.visualizerInstance && window.visualizerInstance.spotifyController) {
                    checkSpotifyPlaybackState();
                } else {
                    // Wait for the Spotify controller to be created
                    const checkSpotifyController = setInterval(() => {
                        if (window.visualizerInstance && window.visualizerInstance.spotifyController) {
                            clearInterval(checkSpotifyController);
                            checkSpotifyPlaybackState();
                        }
                    }, 1000);
                }
                
                // Function to check Spotify playback state directly
                function checkSpotifyPlaybackState() {
                    if (window.visualizerInstance && window.visualizerInstance.spotifyController) {
                        window.visualizerInstance.spotifyController.getPlaybackState().then(state => {
                            if (state && state.playing && shareSongButton.style.display === 'none') {
                                console.log('Spotify is playing via controller check');
                                startShareButtonTimer();
                            }
                        }).catch(err => console.error('Error getting playback state:', err));
                        
                        // Set up periodic checking of playback state
                        setInterval(() => {
                            if (window.visualizerInstance && window.visualizerInstance.spotifyController) {
                                window.visualizerInstance.spotifyController.getPlaybackState().then(state => {
                                    if (state && state.playing && shareSongButton.style.display === 'none') {
                                        console.log('Spotify is playing via interval check');
                                        startShareButtonTimer();
                                    } else if (state && !state.playing) {
                                        clearTimeout(shareSongButtonTimer);
                                        shareSongButton.style.display = 'none';
                                    }
                                }).catch(err => {});
                            }
                        }, 5000); // Check every 5 seconds
                    }
                }
            }
            
            // Check if iframe is already loaded (might happen with cached pages)
            if (spotifyIframe.complete || spotifyIframe.readyState === 4) {
                setTimeout(() => {
                    completeLoading();
                }, 1000);
            }
            
            // Listen for the Spotify iframe API to be ready
            window.onSpotifyIframeApiReady = function(IFrameAPI) {
                // This means the Spotify iframe API is ready
                console.log('Spotify Iframe API Ready');
                
                // Create a Spotify controller when available
                if (window.visualizerInstance) {
                    IFrameAPI.createController(
                        document.getElementById('spotify-player'), 
                        { 
                            uri: 'spotify:track:264hK4WMZsBIpmIhdBXZrh' 
                        }, 
                        (controller) => {
                            window.visualizerInstance.spotifyController = controller;
                            console.log('Spotify controller created');
                            
                            // If we get here, we know the iframe is fully ready
                            completeLoading();
                        }
                    );
                }
            };
            
            // Additional check - in case the normal events don't trigger
            // Check a few times for iframe content visibility
            let readinessCheckCount = 0;
            const checkIframeReadiness = setInterval(() => {
                readinessCheckCount++;
                
                const iframeDoc = spotifyIframe.contentDocument || 
                                 (spotifyIframe.contentWindow && spotifyIframe.contentWindow.document);
                                 
                // If we can see iframe content, it's probably ready
                if (iframeDoc || readinessCheckCount > 20) {
                    completeLoading();
                    clearInterval(checkIframeReadiness);
                }
            }, 500); // Check every 500ms
            
            // Set up windows
            const wmpWindow = document.getElementById('wmp-window');
            const ieWindow = document.getElementById('ie-window');
            const venerusWindow = document.getElementById('venerus-window');
            const windowElements = [wmpWindow, ieWindow, venerusWindow];
            
            const activePrograms = document.getElementById('active-programs');
            
            // Set default visualization pattern (since we removed the button)
            if (window.visualizerInstance) {
                // Set kaleidoscope pattern 2 by default (the bars pattern)
                setTimeout(() => {
                    if (window.visualizerInstance.updateKaleidoscopePattern) {
                        window.visualizerInstance.updateKaleidoscopePattern(2);
                        console.log('Set default kaleidoscope pattern');
                    }
                }, 1000);
            }
            
            // Create program button for taskbar
            function createProgramButton(title, iconSrc, windowId) {
                const programBtn = document.createElement('div');
                programBtn.className = 'program-button';
                programBtn.dataset.window = windowId;
                programBtn.innerHTML = `
                    <img src="${iconSrc}" alt="${title}">
                    ${title}
                `;
                
                // Click to restore window
                programBtn.addEventListener('click', function() {
                    // Check if this is NOT for the WMP window and Venerus mode is active
                    const wmpWindow = document.getElementById('wmp-window');
                    if (windowId !== 'wmp-window' && wmpWindow.classList.contains('venerus-spotify-mode')) {
                        // Exit Venerus Spotify mode
                        wmpWindow.classList.remove('venerus-spotify-mode');
                        wmpWindow.classList.remove('maximized');
                        
                        // Reset window styles
                        wmpWindow.style = '';
                        
                        // Show visualizer and controls again
                        const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                        if (modalVisualizerContainer) {
                            modalVisualizerContainer.style = '';
                        }
                        
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            controls.style = '';
                        }
                        
                        // Reset Spotify iframe height
                        const spotifyIframe = document.getElementById('spotify-player');
                        if (spotifyIframe) {
                            spotifyIframe.style = 'border-radius:12px; display: block !important; position: relative; z-index: 20; width: 100%; height: 152px; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);';
                        }
                        
                        // Minimize WMP window when switching to another window
                        wmpWindow.classList.add('minimized');
                    } else if (windowId === 'wmp-window' && wmpWindow.classList.contains('venerus-spotify-mode')) {
                        // If clicking on WMP's program button while in Venerus mode, exit that mode
                        wmpWindow.classList.remove('venerus-spotify-mode');
                        wmpWindow.classList.remove('maximized');
                        
                        // Reset window styles
                        wmpWindow.style = '';
                        
                        // Show visualizer and controls again
                        const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                        if (modalVisualizerContainer) {
                            modalVisualizerContainer.style = '';
                        }
                        
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            controls.style = '';
                        }
                        
                        // Reset Spotify iframe height
                        const spotifyIframe = document.getElementById('spotify-player');
                        if (spotifyIframe) {
                            spotifyIframe.style = 'border-radius:12px; display: block !important; position: relative; z-index: 20; width: 100%; height: 152px; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);';
                        }
                        
                        // Position window appropriately
                        wmpWindow.style.left = '50%';
                        wmpWindow.style.top = '20%';
                        wmpWindow.style.transform = 'translateX(-50%)';
                        
                        // Update fullscreen button text
                        const fullscreenButton = document.querySelector('.btn-fullscreen');
                        if (fullscreenButton) {
                            fullscreenButton.textContent = 'Expand';
                        }
                    }
                    
                    // Original window restore functionality
                    const win = document.getElementById(windowId);
                    if (win.classList.contains('minimized')) {
                        win.classList.remove('minimized');
                        windowElements.forEach(w => {
                            if (w.id !== windowId && !w.classList.contains('minimized')) {
                                w.style.zIndex = 1;
                            }
                        });
                        win.style.zIndex = 2; // Bring to front
                        updateTaskbarButtons();
                    }
                });
                
                return programBtn;
            }
            
            // Update taskbar buttons based on window states
            function updateTaskbarButtons() {
                // Clear existing program buttons
                activePrograms.innerHTML = '';
                
                // Add program buttons for visible windows
                if (!wmpWindow.classList.contains('minimized') && wmpWindow.style.display !== 'none') {
                    const wmpBtn = createProgramButton('Media Player', 'https://win98icons.alexmeub.com/icons/png/media_player-0.png', 'wmp-window');
                    activePrograms.appendChild(wmpBtn);
                }
                
                if (!ieWindow.classList.contains('minimized') && ieWindow.style.display !== 'none') {
                    const ieBtn = createProgramButton('Internet Explorer', 'https://win98icons.alexmeub.com/icons/png/msie1-0.png', 'ie-window');
                    activePrograms.appendChild(ieBtn);
                }
                
                // Add Venerus window to taskbar
                if (!venerusWindow.classList.contains('minimized') && venerusWindow.style.display !== 'none') {
                    const venerusBtn = createProgramButton('Venerus Spotify', 'https://open.scdn.co/cdn/images/favicon.5cb2bd30.ico', 'venerus-window');
                    activePrograms.appendChild(venerusBtn);
                }
            }
            
            // Set up window controls for all windows
            windowElements.forEach(windowElement => {
                const minimizeBtn = windowElement.querySelector('button[aria-label="Minimize"]');
                const maximizeBtn = windowElement.querySelector('button[aria-label="Maximize"]');
                const closeBtn = windowElement.querySelector('button[aria-label="Close"]');
                
                // Minimize button functionality
                minimizeBtn.addEventListener('click', function() {
                    windowElement.classList.add('minimized');
                    updateTaskbarButtons();
                });
                
                // Maximize button functionality
                maximizeBtn.addEventListener('click', function() {
                    // Instead of always using WMP's handler, check which window we're in first
                    if (windowElement.id === 'wmp-window') {
                        // For WMP window, use the fullscreen button handler
                    const fullscreenButton = document.querySelector('.btn-fullscreen');
                    
                    if (fullscreenButton) {
                        // Create an event-like object
                        const fakeEvent = {
                            preventDefault: function() {},
                            stopPropagation: function() {}
                        };
                        
                        // Get the expand button's handler function
                        const handleFullscreenAction = function(e) {
                            // Prevent any default actions
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const wmpWindow = document.getElementById('wmp-window');
                            const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                            const isMobile = window.innerWidth <= 768;
                                const taskbarHeight = 40; // Consistent 40px taskbar height
                            
                                // Rest of the WMP maximize handler...
                            if (wmpWindow) {
                                // If already maximized, restore to normal size
                                if (wmpWindow.classList.contains('maximized')) {
                                    // Switch back to normal mode (not compact)
                                    wmpWindow.classList.remove('maximized');
                                    wmpWindow.classList.remove('compact-mode');
                                    fullscreenButton.textContent = 'Expand';
                                    
                                    // Clear all important styles when restoring
                                    const stylesToClear = ['width', 'height', 'top', 'left', 'right', 'bottom', 'margin', 'position', 'transform', 'z-index', 'border-radius', 'overflow', 'box-sizing', 'padding', 'max-width'];
                                    stylesToClear.forEach(style => {
                                        wmpWindow.style[style] = '';
                                    });
                                    
                                    // Restore visualizer to normal size
                                    if (modalVisualizerContainer) {
                                        modalVisualizerContainer.style.display = 'block';
                                        modalVisualizerContainer.style.height = '352px';
                                        modalVisualizerContainer.style.minHeight = '352px';
                                    }
                                } else {
                                    // Go to maximized size directly
                                    wmpWindow.classList.remove('compact-mode');
                                    wmpWindow.classList.add('maximized');
                                       // wmpWindow.classList.add('venerus-spotify-mode');
                                    fullscreenButton.textContent = 'Compact';
                                    
                                    // Show the visualizer container
                                    if (modalVisualizerContainer) {
                                        if (isMobile) {
                                                modalVisualizerContainer.style.setProperty('height', 'calc(100vh - 90px)', 'important');
                                            modalVisualizerContainer.style.setProperty('min-height', '300px', 'important');
                                        } else {
                                                modalVisualizerContainer.style.setProperty('height', 'calc(100vh - 230px)', 'important');
                                            modalVisualizerContainer.style.setProperty('min-height', '300px', 'important');
                                        }
                                        modalVisualizerContainer.style.setProperty('display', 'block', 'important');
                                        modalVisualizerContainer.style.setProperty('visibility', 'visible', 'important');
                                    }
                                    
                                    // Set maximized styles
                                    wmpWindow.style.setProperty('width', '100%', 'important');
                                    wmpWindow.style.setProperty('max-width', '100%', 'important');
                                    wmpWindow.style.setProperty('width', '100vw', 'important');
                                    wmpWindow.style.setProperty('height', `calc(100vh - ${taskbarHeight}px)`, 'important');
                                    wmpWindow.style.setProperty('top', '0', 'important');
                                    wmpWindow.style.setProperty('left', '0', 'important');
                                    wmpWindow.style.setProperty('right', '0', 'important');
                                    wmpWindow.style.setProperty('margin', '0', 'important');
                                    wmpWindow.style.setProperty('position', 'fixed', 'important');
                                    wmpWindow.style.setProperty('transform', 'none', 'important');
                                    wmpWindow.style.setProperty('z-index', '2000', 'important');
                                    wmpWindow.style.setProperty('border-radius', '0', 'important');
                                    wmpWindow.style.setProperty('overflow', 'hidden', 'important');
                                    wmpWindow.style.setProperty('box-sizing', 'border-box', 'important');
                                    wmpWindow.style.setProperty('padding', '0', 'important');
                                    wmpWindow.style.setProperty('bottom', `${taskbarHeight}px`, 'important');
                                    
                                    // Apply special style to Spotify iframe when maximized
                                    const spotifyIframe = document.getElementById('spotify-player');
                                    if (spotifyIframe) {
                                        spotifyIframe.style.setProperty('top', '9%', 'important');
                                        spotifyIframe.style.setProperty('left', '4%', 'important');
                                        spotifyIframe.style.setProperty('width', '96%', 'important');
                                        spotifyIframe.style.setProperty('height', 'unset', 'important');
                                    }
                                }
                                
                                // Trigger resize event to make sure visualizer renders correctly
                                setTimeout(() => {
                                    window.dispatchEvent(new Event('resize'));
                                }, 50);
                            }
                            
                            return false;
                        };
                        
                        // Call the function with our fake event
                        handleFullscreenAction.call(fullscreenButton, fakeEvent);
                        }
                    } else {
                        // For other windows (like IE), use standard maximize logic
                        if (windowElement.classList.contains('maximized')) {
                            // Restore to normal size
                            windowElement.classList.remove('maximized');
                            windowElement.style.width = '';
                            windowElement.style.height = '';
                            windowElement.style.top = '';
                            windowElement.style.left = '';
                            windowElement.style.right = '';
                            windowElement.style.bottom = '';
                            windowElement.style.transform = '';
                            windowElement.style.position = '';
                            windowElement.style.margin = '';
                            windowElement.style.overflow = '';
                            windowElement.style.boxSizing = '';
                            windowElement.style.padding = '';
                        } else {
                            // Go to maximized mode
                            const isMobile = window.innerWidth <= 768;
                            const taskbarHeight = 40;
                            
                            windowElement.classList.add('maximized');
                            windowElement.style.setProperty('width', '100%', 'important');
                            windowElement.style.setProperty('max-width', '100%', 'important');
                            windowElement.style.setProperty('width', '100vw', 'important');
                            windowElement.style.setProperty('height', `calc(100vh - ${taskbarHeight}px)`, 'important');
                            windowElement.style.setProperty('top', '0', 'important');
                            windowElement.style.setProperty('left', '0', 'important');
                            windowElement.style.setProperty('right', '0', 'important');
                            windowElement.style.setProperty('margin', '0', 'important');
                            windowElement.style.setProperty('position', 'fixed', 'important');
                            windowElement.style.setProperty('transform', 'none', 'important');
                            windowElement.style.setProperty('z-index', '2000', 'important');
                            windowElement.style.setProperty('border-radius', '0', 'important');
                            windowElement.style.setProperty('overflow', 'hidden', 'important');
                            windowElement.style.setProperty('box-sizing', 'border-box', 'important');
                            windowElement.style.setProperty('padding', '0', 'important');
                            windowElement.style.setProperty('bottom', `${taskbarHeight}px`, 'important');
                            
                            // Apply special style to Spotify iframe when maximized
                            const spotifyIframe = document.getElementById('spotify-player');
                            if (spotifyIframe) {
                                spotifyIframe.style.setProperty('top', '9%', 'important');
                                spotifyIframe.style.setProperty('left', '4%', 'important');
                                spotifyIframe.style.setProperty('width', '96%', 'important');
                                spotifyIframe.style.setProperty('height', 'unset', 'important');
                            }
                        }
                    }
                });
                
                // Close button functionality
                closeBtn.addEventListener('click', function() {
                    windowElement.classList.add('minimized');
                    updateTaskbarButtons();
                });
                
                // Bring window to front when clicked
                windowElement.addEventListener('mousedown', function() {
                    windowElements.forEach(w => {
                        if (w !== windowElement) {
                            w.style.zIndex = 1;
                        }
                    });
                    windowElement.style.zIndex = 2;
                    updateTaskbarButtons();
                });
            });
            
            // WMP icon click to toggle window
            const wmpIcon = document.getElementById('wmp-icon');
            wmpIcon.addEventListener('click', function() {
                // Check if Venerus Spotify mode is active and reset it
                const wmpWindow = document.getElementById('wmp-window');
                if (wmpWindow.classList.contains('venerus-spotify-mode')) {
                    // Exit Venerus Spotify mode
                    wmpWindow.classList.remove('venerus-spotify-mode');
                    wmpWindow.classList.remove('maximized');
                    
                    // Reset window styles
                    wmpWindow.style = '';
                    
                    // Show visualizer and controls again
                    const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                    if (modalVisualizerContainer) {
                        modalVisualizerContainer.style = '';
                    }
                    
                    const controls = document.querySelector('.controls');
                    if (controls) {
                        controls.style = '';
                    }
                    
                    // Reset Spotify iframe height
                    const spotifyIframe = document.getElementById('spotify-player');
                    if (spotifyIframe) {
                        spotifyIframe.style = 'border-radius:12px; display: block !important; position: relative; z-index: 20; width: 100%; height: 152px; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);';
                    }
                    
                    // Position window appropriately
                    wmpWindow.style.left = '50%';
                    wmpWindow.style.top = '20%';
                    wmpWindow.style.transform = 'translateX(-50%)';
                    
                    // Update fullscreen button text
                    const fullscreenButton = document.querySelector('.btn-fullscreen');
                    if (fullscreenButton) {
                        fullscreenButton.textContent = 'Expand';
                    }
                } 
                
                // Original WMP icon functionality
                if (wmpWindow.classList.contains('minimized')) {
                    wmpWindow.classList.remove('minimized');
                    windowElements.forEach(w => {
                        if (w !== wmpWindow) w.style.zIndex = 1;
                    });
                    wmpWindow.style.zIndex = 2;
                } else if (wmpWindow.style.display !== 'none') {
                    wmpWindow.classList.add('minimized');
                } else {
                    wmpWindow.style.display = 'block';
                    windowElements.forEach(w => {
                        if (w !== wmpWindow) w.style.zIndex = 1;
                    });
                    wmpWindow.style.zIndex = 2;
                }
                updateTaskbarButtons();
            });
            
            // IE icon click to toggle window
            const ieIcon = document.getElementById('ie-icon');
            ieIcon.addEventListener('click', function() {
                // Also check if Venerus Spotify mode is active and reset it
                const wmpWindow = document.getElementById('wmp-window');
                if (wmpWindow.classList.contains('venerus-spotify-mode')) {
                    // Exit Venerus Spotify mode
                    wmpWindow.classList.remove('venerus-spotify-mode');
                    wmpWindow.classList.remove('maximized');
                    
                    // Reset window styles
                    wmpWindow.style = '';
                    
                    // Show visualizer and controls again
                    const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                    if (modalVisualizerContainer) {
                        modalVisualizerContainer.style = '';
                    }
                    
                    const controls = document.querySelector('.controls');
                    if (controls) {
                        controls.style = '';
                    }
                    
                    // Reset Spotify iframe height
                    const spotifyIframe = document.getElementById('spotify-player');
                    if (spotifyIframe) {
                        spotifyIframe.style = 'border-radius:12px; display: block !important; position: relative; z-index: 20; width: 100%; height: 152px; visibility: visible; opacity: 1; background-color: white; background-image: linear-gradient(to bottom, #f5f5f5, #eaeaea);';
                    }
                    
                    // Minimize WMP window so it doesn't interfere with IE
                    wmpWindow.classList.add('minimized');
                }
                
                // Original IE icon functionality
                if (ieWindow.classList.contains('minimized')) {
                    ieWindow.classList.remove('minimized');
                    windowElements.forEach(w => {
                        if (w !== ieWindow) w.style.zIndex = 1;
                    });
                    ieWindow.style.zIndex = 2;
                } else if (ieWindow.style.display !== 'none') {
                    ieWindow.classList.add('minimized');
                } else {
                    ieWindow.style.display = 'block';
                    windowElements.forEach(w => {
                        if (w !== ieWindow) w.style.zIndex = 1;
                    });
                    ieWindow.style.zIndex = 2;
                }
                updateTaskbarButtons();
            });
            
            // Initialize taskbar
            updateTaskbarButtons();
            
            // Changed from Show Desktop to Venerus Spotify Player functionality
            const showDesktopBtn = document.getElementById('show-desktop');
            showDesktopBtn.addEventListener('click', function() {
                // Open Venerus Spotify in its dedicated window
                const venerusWindow = document.getElementById('venerus-window');
                
                // Make sure the Venerus window is visible
                venerusWindow.style.display = 'block';
                venerusWindow.classList.remove('minimized');
                
                // Bring it to front
                    windowElements.forEach(w => {
                    if (w !== venerusWindow) w.style.zIndex = 1;
                });
                venerusWindow.style.zIndex = 2;
                
                // Maximize it
                venerusWindow.classList.add('maximized');
                
                // Set maximized styles
                const taskbarHeight = 40;
                venerusWindow.style.setProperty('width', '100%', 'important');
                venerusWindow.style.setProperty('max-width', '100%', 'important');
                venerusWindow.style.setProperty('width', '100vw', 'important');
                venerusWindow.style.setProperty('height', `calc(100vh - ${taskbarHeight}px)`, 'important');
                venerusWindow.style.setProperty('top', '0', 'important');
                venerusWindow.style.setProperty('left', '0', 'important');
                venerusWindow.style.setProperty('right', '0', 'important');
                venerusWindow.style.setProperty('margin', '0', 'important');
                venerusWindow.style.setProperty('position', 'fixed', 'important');
                venerusWindow.style.setProperty('transform', 'none', 'important');
                venerusWindow.style.setProperty('z-index', '2000', 'important');
                venerusWindow.style.setProperty('border-radius', '0', 'important');
                venerusWindow.style.setProperty('overflow', 'hidden', 'important');
                venerusWindow.style.setProperty('box-sizing', 'border-box', 'important');
                venerusWindow.style.setProperty('padding', '0', 'important');
                venerusWindow.style.setProperty('bottom', `${taskbarHeight}px`, 'important');
                
                // Update taskbar buttons
                updateTaskbarButtons();
            });
            
            // Set up clock with date and time
            function updateClock() {
                const now = new Date();
                
                // First verify elements exist before setting content
                const timeDisplay = document.querySelector('.time-display');
                const dateDisplay = document.querySelector('.date-display');
                
                // Make sure elements exist
                if (!timeDisplay || !dateDisplay) {
                    // If elements don't exist, create them
                    const taskbarTime = document.getElementById('taskbar-time');
                    if (taskbarTime) {
                        // Clear any existing content
                        taskbarTime.innerHTML = '';
                        
                        // Create the time display element if it doesn't exist
                        const newTimeDisplay = document.createElement('div');
                        newTimeDisplay.className = 'time-display';
                        taskbarTime.appendChild(newTimeDisplay);
                        
                        // Create the date display element if it doesn't exist
                        const newDateDisplay = document.createElement('div');
                        newDateDisplay.className = 'date-display';
                        taskbarTime.appendChild(newDateDisplay);
                        
                        // Try again with the new elements
                        updateClock();
                        return;
                    }
                }
                
                // Update time if element exists
                if (timeDisplay) {
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                    timeDisplay.textContent = `${hours}:${minutes}`;
                }
                
                // Update date if element exists
                if (dateDisplay) {
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const year = now.getFullYear();
                    dateDisplay.textContent = `${month}/${day}/${year}`;
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);

            // Add play/pause button functionality with improved touch support
            const playPauseButton = document.querySelector('.btn-play-pause');
            if (playPauseButton) {
                // Function to handle both click and touch events
                const handlePlayPauseAction = function(e) {
                    // Prevent any default actions
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // This will call the visualizer's togglePlayback method
                    if (window.visualizerInstance) {
                        console.log('Play/Pause button activated');
                        window.visualizerInstance.togglePlayback();
                        
                        // Add a visual feedback that the button was clicked
                        const originalBackground = this.style.backgroundColor || '';
                        this.style.backgroundColor = '#d4ffd4';
                        setTimeout(() => {
                            this.style.backgroundColor = originalBackground;
                        }, 300);
                    }
                    
                    return false;
                };
                
                // Add both click and touchend listeners
                playPauseButton.addEventListener('click', handlePlayPauseAction);
                playPauseButton.addEventListener('touchend', handlePlayPauseAction);
            }

            // Add visualization button functionality with improved touch support
            const visualizationButton = document.querySelector('.btn-visualization');
            if (visualizationButton) {
                let visualizationStyle = 6; // Start with low intensity
                const styleLabels = ['Low', 'Medium', 'High'];
                
                // Function to handle both click and touch events
                const handleVisualizationAction = function(e) {
                    // Prevent any default actions
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Rotate through visualization styles
                    visualizationStyle = (visualizationStyle + 1) % 3;
                    
                    // Update button text
                    this.textContent = `Visual: ${styleLabels[visualizationStyle]}`;
                    
                    // Update visualization in the Visualizer instance
                    if (window.visualizerInstance) {
                        window.visualizerInstance.updateVisualizationStyle(visualizationStyle);
                        
                        // Add visual feedback
                        const originalBackground = this.style.backgroundColor || '';
                        this.style.backgroundColor = '#d4f4ff';
                        setTimeout(() => {
                            this.style.backgroundColor = originalBackground;
                        }, 300);
                    }
                    
                    return false;
                };
                
                // Add both click and touchend listeners
                visualizationButton.addEventListener('click', handleVisualizationAction);
                visualizationButton.addEventListener('touchend', handleVisualizationAction);
            }
            
            // Add fullscreen functionality with improved touch support
            const fullscreenButton = document.querySelector('.btn-fullscreen');
            if (fullscreenButton) {
                // Function to handle both click and touch events
                const handleFullscreenAction = function(e) {
                    // Prevent any default actions
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const wmpWindow = document.getElementById('wmp-window');
                    const modalVisualizerContainer = document.querySelector('.modal-visualizer-container');
                    const isMobile = window.innerWidth <= 768;
                    const taskbarHeight = 40; // Consistent 40px taskbar height
                    
                    if (wmpWindow) {
                        // If already maximized, go back to normal mode (not compact)
                        if (wmpWindow.classList.contains('maximized')) {
                            // Go back to normal mode (not compact)
                            wmpWindow.classList.remove('maximized');
                            wmpWindow.classList.remove('compact-mode');
                            wmpWindow.classList.remove('venerus-spotify-mode');
                            this.textContent = 'Expand';
                            
                            // Clear all important styles when switching to normal
                            const stylesToClear = ['width', 'height', 'top', 'left', 'right', 'bottom', 'margin', 'position', 'transform', 'z-index', 'border-radius', 'overflow', 'box-sizing', 'padding', 'max-width'];
                            stylesToClear.forEach(style => {
                                wmpWindow.style[style] = '';
                            });
                            
                            // Restore visualizer to normal size
                            if (modalVisualizerContainer) {
                                modalVisualizerContainer.style.display = 'block';
                                modalVisualizerContainer.style.height = '352px';
                                modalVisualizerContainer.style.minHeight = '352px';
                            }
                            
                            // If the window is off-screen, center it
                            const rect = wmpWindow.getBoundingClientRect();
                            if (rect.right > window.innerWidth || rect.bottom > window.innerHeight || 
                                rect.left < 0 || rect.top < 0) {
                                wmpWindow.style.left = '50%';
                                wmpWindow.style.top = '40%';
                                wmpWindow.style.transform = 'translate(-50%, -50%)';
                            }
                        } 
                        // If in normal or compact mode, go to maximized
                        
                        else {
                            // Go to expanded size / maximized directly
                            wmpWindow.classList.remove('compact-mode');
                            wmpWindow.classList.add('maximized');
                           // wmpWindow.classList.add('venerus-spotify-mode');
                            this.textContent = 'Compact';
                            
                            // Show the visualizer container
                            if (modalVisualizerContainer) {
                                if (isMobile) {
                                    modalVisualizerContainer.style.setProperty('height', 'calc(100vh - 352px)', 'important');
                                    modalVisualizerContainer.style.setProperty('min-height', '300px', 'important');
                                } else {
                                    modalVisualizerContainer.style.setProperty('height', 'calc(100vh - 280px)', 'important');
                                    modalVisualizerContainer.style.setProperty('min-height', '300px', 'important');
                                }
                                modalVisualizerContainer.style.setProperty('display', 'block', 'important');
                                modalVisualizerContainer.style.setProperty('visibility', 'visible', 'important');
                            }
                            
                            // Set maximized styles
                            wmpWindow.style.setProperty('width', '100%', 'important');
                            wmpWindow.style.setProperty('max-width', '100%', 'important');
                            wmpWindow.style.setProperty('width', '100vw', 'important');
                            wmpWindow.style.setProperty('height', `calc(100vh - ${taskbarHeight}px)`, 'important');
                            wmpWindow.style.setProperty('top', '0', 'important');
                            wmpWindow.style.setProperty('left', '0', 'important');
                            wmpWindow.style.setProperty('right', '0', 'important');
                            wmpWindow.style.setProperty('margin', '0', 'important');
                            wmpWindow.style.setProperty('position', 'fixed', 'important');
                            wmpWindow.style.setProperty('transform', 'none', 'important');
                            wmpWindow.style.setProperty('z-index', '2000', 'important');
                            wmpWindow.style.setProperty('border-radius', '0', 'important');
                            wmpWindow.style.setProperty('overflow', 'hidden', 'important');
                            wmpWindow.style.setProperty('box-sizing', 'border-box', 'important');
                            wmpWindow.style.setProperty('padding', '0', 'important');
                            wmpWindow.style.setProperty('bottom', `${taskbarHeight}px`, 'important');
                            
                            // Apply special style to Spotify iframe when maximized
                            const spotifyIframe = document.getElementById('spotify-player');
                            if (spotifyIframe) {
                                spotifyIframe.style.setProperty('top', '9%', 'important');
                                spotifyIframe.style.setProperty('left', '4%', 'important');
                                spotifyIframe.style.setProperty('width', '96%', 'important');
                                spotifyIframe.style.setProperty('height', 'unset', 'important');
                            }
                        }
                        
                        // Add visual feedback
                        const originalBackground = this.style.backgroundColor || '';
                        this.style.backgroundColor = '#f0f0f0';
                        setTimeout(() => {
                            this.style.backgroundColor = originalBackground;
                        }, 300);
                        
                        // Trigger resize event to make sure visualizer renders correctly
                        setTimeout(() => {
                            window.dispatchEvent(new Event('resize'));
                        }, 50);
                    }
                    
                    return false;
                };
                
                // Add both click and touchend listeners
                fullscreenButton.addEventListener('click', handleFullscreenAction);
                fullscreenButton.addEventListener('touchend', handleFullscreenAction);
                
                // Update button text initially
                fullscreenButton.textContent = 'Expand';
            }
            
            // Add direct event listener for Spotify iframe interaction
            const spotifyPlayer = document.getElementById('spotify-player');
            if (spotifyPlayer) {
                // Create a proxy for messages coming from the iframe
                window.addEventListener('message', function(event) {
                    if (event.source === spotifyPlayer.contentWindow) {
                        console.log('Message from Spotify iframe:', event.data);
                        
                        // Process the message and update UI if needed
                        if (window.visualizerInstance && event.data) {
                            // Look for Spotify API messages that indicate playback state
                            let isPlaying = null;
                            
                            try {
                                // These are the various formats Spotify uses in their messages
                                if (event.data.type === 'playback_update') {
                                    isPlaying = !event.data.isPaused;
                                } else if (event.data.type === 'player_state_changed') {
                                    isPlaying = !event.data.payload?.paused;
                                } else if (event.data.playing !== undefined) {
                                    isPlaying = event.data.playing;
                                } else if (event.data.data?.isPaused !== undefined) {
                                    isPlaying = !event.data.data.isPaused;
                                } else if (event.data.command === 'play') {
                                    isPlaying = true;
                                } else if (event.data.command === 'pause') {
                                    isPlaying = false;
                                }
                                
                                // Update visualizer if we detected a valid state change
                                if (isPlaying !== null) {
                                    window.visualizerInstance.updatePlaybackStatus(isPlaying);
                                    window.visualizerInstance.intensity = isPlaying ? 1.0 : 0.5;
                                    
                                    // Hide or show the Spotify iframe based on playback status
                                    const spotifyIframe = document.querySelector('#spotify-player');
                                    if (spotifyIframe) {
                                        if (isPlaying) {
                                            // Hide iframe when playing
                                            spotifyIframe.style.setProperty('display', 'none', 'important');
                                        } else {
                                            // Show iframe when paused
                                            spotifyIframe.style.setProperty('display', 'block', 'important');
                                        }
                                    }
                                }
                            } catch (e) {
                                console.warn('Error processing Spotify message:', e);
                            }
                        }
                    }
                });
                
                // Add a polling mechanism to check for changes in the iframe
                let lastPlayState = false;
                let spotifyCheckInterval = setInterval(() => {
                    try {
                        // Try different methods to detect playback state
                        if (window.visualizerInstance) {
                            // Method 1: Check if the iframe has specific UI elements that indicate playback
                            let foundPlaying = false;
                            
                            // If clicked recently, check more aggressively 
                            const iframe = document.querySelector('#spotify-player');
                            if (iframe) {
                                // Method 2: Use Spotify's iframe API if available
                                if (window.visualizerInstance.spotifyController) {
                                    window.visualizerInstance.spotifyController.getPlaybackState()
                                    .then(state => {
                                        const isPlaying = state && !state.isPaused;
                                        if (isPlaying !== lastPlayState) {
                                            lastPlayState = isPlaying;
                                            window.visualizerInstance.updatePlaybackStatus(isPlaying);
                                            window.visualizerInstance.intensity = isPlaying ? 1.0 : 0.5;
                                            console.log('Detected playback change via API:', isPlaying);
                                            
                                            // Hide or show the Spotify iframe based on playback status
                                            const spotifyIframe = document.querySelector('#spotify-player');
                                            if (spotifyIframe) {
                                                if (isPlaying) {
                                                    // Hide iframe when playing
                                                    spotifyIframe.style.setProperty('display', 'none', 'important');
                                                } else {
                                                    // Show iframe when paused
                                                    spotifyIframe.style.setProperty('display', 'block', 'important');
                                                }
                                            }
                                        }
                                    })
                                    .catch(err => {
                                        // Silent fail, API might not be ready
                                        foundPlaying = window.visualizerInstance.isPlaying;
                                    });
                                } else {
                                    // Fallback - just update based on known state
                                    foundPlaying = window.visualizerInstance.isPlaying;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Error in Spotify status check:', e);
                    }
                }, 1000); // Check every second
                
                // Make sure to clean up the interval when page unloads
                window.addEventListener('beforeunload', () => {
                    clearInterval(spotifyCheckInterval);
                });
            }
        });
    </script>
    
    <!-- CRT Shader Overlay -->
    <div id="crt-overlay-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99999999999999999999; opacity: 0.55;">
        <canvas id="crt-overlay" style="width: 100%; height: 100%;"></canvas>
    </div>
    
    <!-- CRT Effect Toggle Controls (Windows 98 style) -->
    <div class="crt-toggle-container" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 10000; background-color: #c0c0c0; border: 2px solid; border-color: #ffffff #808080 #808080 #ffffff; padding: 6px; font-family: 'MS Sans Serif', sans-serif; font-size: 11px;">
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>CRT Effect:</span>
                <button id="toggle-crt-effect" class="window-button" style="padding: 2px 8px; background: #c0c0c0; border: 2px solid; border-color: #ffffff #808080 #808080 #ffffff; margin-left: 4px;">ON</button>
            </div>
            <div style="display: flex; align-items: center; margin-top: 2px;">
                <span>Intensity:</span>
                <input type="range" id="crt-intensity" min="0.1" max="1.0" step="0.1" value="0.7" style="width: 100px; margin-left: 4px;">
                <span id="intensity-value" style="margin-left: 4px; min-width: 20px;">0.7</span>
            </div>
            <div style="display: flex; align-items: center; margin-top: 2px;">
                <span>Mode:</span>
                <select id="crt-mode" style="margin-left: 4px; background: #fff; border: 2px inset #808080; font-family: 'MS Sans Serif', sans-serif; font-size: 11px;">
                    <option value="crt">CRT Monitor</option>
                    <option value="lcd">Early LCD</option>
                    <option value="xp">Windows XP</option>
                    <option value="win98">Windows 98</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // CRT Shader Effect Implementation
        class CRTOverlay {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
                
                // Get the canvas and setup renderer
                this.canvas = document.getElementById('crt-overlay');
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    alpha: true
                });
                
                this.clock = new THREE.Clock();
                this.intensity = 0.4; // Higher intensity for better visibility
                this.enabled = true;
                this.mode = 'crt'; // Default mode
                
                // Set renderer size to match window
                this.handleResize();
                
                // Setup resize listener
                window.addEventListener('resize', () => this.handleResize());
                
                // Setup controls
                this.setupControls();
                
                // Initialize with shader loading
                this.initialize();
            }
            
            setupControls() {
                // Toggle button
                this.toggleButton = document.getElementById('toggle-crt-effect');
                this.toggleButton.addEventListener('click', () => this.toggleEffect());
                
                // Intensity slider
                this.intensitySlider = document.getElementById('crt-intensity');
                this.intensityValue = document.getElementById('intensity-value');
                this.intensitySlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    this.setIntensity(value);
                    this.intensityValue.textContent = value.toFixed(1);
                });
                
                // Mode selector
                this.modeSelector = document.getElementById('crt-mode');
                this.modeSelector.addEventListener('change', (e) => {
                    this.setMode(e.target.value);
                });
            }
            
            async initialize() {
                try {
                    // Create a basic texture to apply the effect to
                    const canvasCapture = document.createElement('canvas');
                    canvasCapture.width = window.innerWidth;
                    canvasCapture.height = window.innerHeight;
                    this.captureTexture = new THREE.CanvasTexture(canvasCapture);
                    this.captureTexture.minFilter = THREE.LinearFilter;
                    this.captureTexture.magFilter = THREE.LinearFilter;
                    
                    // Load shaders
                    const vertexShader = await this.loadFile('vertex-shader.glsl');
                    const fragmentShader = await this.loadFile('shaders/crt-shader.glsl');
                    
                    // Record start time for fade-in effect
                    this.startTime = this.clock.getElapsedTime();
                    
                    // Create shader material
                    const geometry = new THREE.PlaneGeometry(2, 2);
                    const material = new THREE.ShaderMaterial({
                        vertexShader,
                        fragmentShader,
                        uniforms: {
                            iTime: { value: 0 },
                            iResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
                            iIntensity: { value: this.intensity },
                            iTexture: { value: this.captureTexture },
                            iMode: { value: 0 }, // 0 = CRT, 1 = LCD, 2 = XP, 3 = Win98
                            iStartTime: { value: this.startTime } // Add start time for fade-in effect
                        },
                        transparent: true
                    });
                    
                    // Create mesh with the shader
                    const mesh = new THREE.Mesh(geometry, material);
                    this.scene.add(mesh);
                    
                    // Store references for animation
                    this.material = material;
                    
                    // Start animation loop
                    this.animate();
                    
                    console.log("CRT overlay initialized successfully!");
                } catch (error) {
                    console.error("Error initializing CRT overlay:", error);
                }
            }
            
            async loadFile(url) {
                const response = await fetch(url);
                return await response.text();
            }
            
            handleResize() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                this.renderer.setSize(width, height);
                
                if (this.material && this.material.uniforms.iResolution) {
                    this.material.uniforms.iResolution.value.set(width, height);
                }
                
                // Update capture texture size if needed
                if (this.captureTexture) {
                    const context = this.captureTexture.image.getContext('2d');
                    this.captureTexture.image.width = width;
                    this.captureTexture.image.height = height;
                    this.captureTexture.needsUpdate = true;
                }
            }
            
            animate() {
                if (!this.enabled) {
                    requestAnimationFrame(() => this.animate());
                    return;
                }
                
                // Update time uniform
                if (this.material) {
                    this.material.uniforms.iTime.value = this.clock.getElapsedTime();
                }
                
                // Capture the current page as texture
                this.updateCaptureTexture();
                
                // Render the effect
                this.renderer.render(this.scene, this.camera);
                
                // Continue animation loop
                requestAnimationFrame(() => this.animate());
            }
            
            updateCaptureTexture() {
                // For performance reasons, we don't actually capture the screen
                // Instead, we just use the effect directly on top of the page content
                
                if (this.material && this.material.uniforms.iIntensity) {
                    // Apply special effects based on mode
                    if (this.mode === 'win98') {
                        // Add a very subtle pulsing for win98 mode
                        const pulse = Math.sin(this.clock.getElapsedTime() * 0.5) * 0.05;
                        this.material.uniforms.iIntensity.value = this.intensity + pulse;
                    }
                }
            }
            
            toggleEffect() {
                this.enabled = !this.enabled;
                
                const container = document.getElementById('crt-overlay-container');
                if (this.enabled) {
                    container.style.display = 'block';
                    this.toggleButton.textContent = 'ON';
                    
                    // Reset start time to create fade-in effect when toggled back on
                    this.startTime = this.clock.getElapsedTime();
                    if (this.material && this.material.uniforms.iStartTime) {
                        this.material.uniforms.iStartTime.value = this.startTime;
                    }
                } else {
                    container.style.display = 'none';
                    this.toggleButton.textContent = 'OFF';
                }
            }
            
            setIntensity(value) {
                this.intensity = value;
                if (this.material && this.material.uniforms.iIntensity) {
                    this.material.uniforms.iIntensity.value = value;
                }
            }
            
            setMode(mode) {
                this.mode = mode;
                if (this.material && this.material.uniforms.iMode) {
                    switch(mode) {
                        case 'crt':
                            this.material.uniforms.iMode.value = 0;
                            break;
                        case 'lcd':
                            this.material.uniforms.iMode.value = 1;
                            break;
                        case 'xp':
                            this.material.uniforms.iMode.value = 2;
                            break;
                        case 'win98':
                            this.material.uniforms.iMode.value = 3;
                            break;
                    }
                }
            }
        }
        
        // Initialize the CRT overlay after page load
        window.addEventListener('load', () => {
            // Make sure THREE.js is loaded first
            if (typeof THREE !== 'undefined') {
                window.crtOverlay = new CRTOverlay();
            } else {
                console.error('THREE.js not loaded, cannot initialize CRT effect');
            }
        });
    </script>
</body>
</html> 